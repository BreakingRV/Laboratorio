<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Estado del Laboratorio</title>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; }
  #login-section, #register-section, #app-section { margin-bottom: 20px; }
  #status { font-weight: bold; }
</style>
</head>
<body>

<h1>Estado del Laboratorio</h1>

<!-- Registro -->
<div id="register-section">
  <h3>Registrar cuenta</h3>
  <input type="email" id="register-email" placeholder="Correo" /><br/>
  <input type="password" id="register-password" placeholder="Contraseña" /><br/>
  <button id="btn-register">Registrar</button>
  <p id="register-msg"></p>
</div>

<!-- Login -->
<div id="login-section">
  <h3>Iniciar sesión</h3>
  <input type="email" id="login-email" placeholder="Correo" /><br/>
  <input type="password" id="login-password" placeholder="Contraseña" /><br/>
  <button id="btn-login">Entrar</button>
  <button id="btn-logout" style="display:none;">Salir</button>
  <p id="login-msg"></p>
</div>

<!-- Aplicación -->
<div id="app-section" style="display:none;">
  <p>Estado actual del laboratorio: <span id="status">Desconocido</span></p>
  <button id="btn-toggle-status">Cambiar estado</button>
  <p id="status-msg"></p>

  <h3>Últimos 4 cambios:</h3>
  <ul id="history-list"></ul>
</div>

<script>
  // Configura tu Firebase aquí
const firebaseConfig = {
  apiKey: "AIzaSyApRN9cnGIPsW_kNHtSfPpXWD4_TwrrBPk",
  authDomain: "estado-laboratorio.firebaseapp.com",
  databaseURL: "https://estado-laboratorio-default-rtdb.firebaseio.com",
  projectId: "estado-laboratorio",
  storageBucket: "estado-laboratorio.firebasestorage.app",
  messagingSenderId: "449135433069",
  appId: "1:449135433069:web:acf49b3ef481ee9799f664",
  measurementId: "G-HL7R07P79H"
};

  // Inicializa Firebase
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  // Elementos DOM
  const registerEmail = document.getElementById('register-email');
  const registerPassword = document.getElementById('register-password');
  const btnRegister = document.getElementById('btn-register');
  const registerMsg = document.getElementById('register-msg');

  const loginEmail = document.getElementById('login-email');
  const loginPassword = document.getElementById('login-password');
  const btnLogin = document.getElementById('btn-login');
  const btnLogout = document.getElementById('btn-logout');
  const loginMsg = document.getElementById('login-msg');

  const appSection = document.getElementById('app-section');
  const statusSpan = document.getElementById('status');
  const btnToggleStatus = document.getElementById('btn-toggle-status');
  const statusMsg = document.getElementById('status-msg');
  const historyList = document.getElementById('history-list');

  let currentUserData = null; // Para guardar info de user aprobado

  // Registro de usuario
  btnRegister.onclick = async () => {
    const email = registerEmail.value.trim();
    const password = registerPassword.value.trim();
    registerMsg.textContent = '';
    if (!email || !password) {
      registerMsg.textContent = 'Completa email y contraseña.';
      return;
    }
    try {
      const cred = await auth.createUserWithEmailAndPassword(email, password);
      // Crear documento en users con approved: false
      await db.collection('users').doc(cred.user.uid).set({
        email,
        approved: false,
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      });
      registerMsg.style.color = 'green';
      registerMsg.textContent = 'Cuenta creada. Espera a que un administrador apruebe tu cuenta.';
    } catch (error) {
      registerMsg.style.color = 'red';
      registerMsg.textContent = error.message;
    }
  };

  // Login
  btnLogin.onclick = async () => {
    const email = loginEmail.value.trim();
    const password = loginPassword.value.trim();
    loginMsg.textContent = '';
    if (!email || !password) {
      loginMsg.textContent = 'Completa email y contraseña.';
      return;
    }
    try {
      await auth.signInWithEmailAndPassword(email, password);
      loginMsg.textContent = '';
    } catch (error) {
      loginMsg.style.color = 'red';
      loginMsg.textContent = error.message;
    }
  };

  btnLogout.onclick = () => {
    auth.signOut();
  };

  // Escuchar cambios de estado auth
  auth.onAuthStateChanged(async (user) => {
    if (user) {
      // Checar si user aprobado
      const docUser = await db.collection('users').doc(user.uid).get();
      if (!docUser.exists || !docUser.data().approved) {
        loginMsg.style.color = 'red';
        loginMsg.textContent = 'Tu cuenta no ha sido aprobada aún.';
        await auth.signOut();
        return;
      }

      currentUserData = docUser.data();

      // Mostrar UI app y ocultar login/registro
      appSection.style.display = 'block';
      document.getElementById('login-section').style.display = 'none';
      document.getElementById('register-section').style.display = 'none';
      btnLogout.style.display = 'inline-block';
      loginMsg.textContent = '';

      // Mostrar estado actual
      listenLabStatus();
      loadHistory();

    } else {
      currentUserData = null;
      appSection.style.display = 'none';
      document.getElementById('login-section').style.display = 'block';
      document.getElementById('register-section').style.display = 'block';
      btnLogout.style.display = 'none';
      statusSpan.textContent = 'Desconocido';
      historyList.innerHTML = '';
    }
  });

  // Función para escuchar cambios en estado del laboratorio
  function listenLabStatus() {
    db.collection('labStatus').doc('current')
      .onSnapshot(doc => {
        if (doc.exists) {
          const estado = doc.data().estado;
          statusSpan.textContent = estado === 'libre' ? 'LIBRE' : 'OCUPADO';
        } else {
          statusSpan.textContent = 'Desconocido';
        }
      });
  }

  // Cambiar estado del laboratorio
  btnToggleStatus.onclick = async () => {
    if (!currentUserData) {
      statusMsg.style.color = 'red';
      statusMsg.textContent = 'No autorizado.';
      return;
    }
    try {
      // Obtener estado actual
      const doc = await db.collection('labStatus').doc('current').get();
      let nuevoEstado = 'libre';
      if (doc.exists && doc.data().estado === 'libre') {
        nuevoEstado = 'ocupado';
      }

      // Actualizar estado
      await db.collection('labStatus').doc('current').set({
        estado: nuevoEstado,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
      });

      // Agregar registro a historial
      await db.collection('history').add({
        userId: auth.currentUser.uid,
        email: auth.currentUser.email,
        estado: nuevoEstado,
        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
      });

      statusMsg.style.color = 'green';
      statusMsg.textContent = `Estado cambiado a ${nuevoEstado.toUpperCase()}`;
      loadHistory();
    } catch (error) {
      statusMsg.style.color = 'red';
      statusMsg.textContent = 'Error: ' + error.message;
    }
  };

  // Cargar últimos 4 cambios
  async function loadHistory() {
    const snapshot = await db.collection('history')
      .orderBy('timestamp', 'desc')
      .limit(4)
      .get();
    historyList.innerHTML = '';
    snapshot.forEach(doc => {
      const data = doc.data();
      const fecha = data.timestamp?.toDate().toLocaleString() || 'sin fecha';
      const li = document.createElement('li');
      li.textContent = `${fecha}: ${data.email} cambió a ${data.estado.toUpperCase()}`;
      historyList.appendChild(li);
    });
  }
</script>

</body>
</html>
